---
sidebar_position: 3
---
import Admonition from '@theme/Admonition';

# Mode 2: Bring-your-own Hub

## Description
You provide an existing hub infrastructure (VNET, Key Vault, metastore, NCC, network policy). SRA creates only the spoke workspace with a managed spoke network.

## What Gets Created

<div className='rounded-lg mb-6 overflow-hidden'>
<table className='w-full'>
  <thead className='bg-gray-100'>
    <tr>
      <th className='p-3 text-left'>Resource</th>
      <th className='p-3 text-left'>Component</th>
      <th className='p-3 text-center'>Created by SRA</th>
    </tr>
  </thead>
  <tbody>
    <tr className='bg-gray-50'>
      <td className='p-3' rowSpan={4}><strong>Hub Resource Group</strong></td>
      <td className='p-3'>Hub VNET + Azure Firewall</td>
      <td className='p-3 text-center'>✗ (You provide)</td>
    </tr>
    <tr className='bg-gray-50'>
      <td className='p-3'>Webauth Workspace</td>
      <td className='p-3 text-center'>✗ (You provide)</td>
    </tr>
    <tr className='bg-gray-50'>
      <td className='p-3'>CMK KeyVault</td>
      <td className='p-3 text-center'>✗ (You provide)</td>
    </tr>
    <tr className='bg-gray-50'>
      <td className='p-3'>Route Table</td>
      <td className='p-3 text-center'>✗ (You provide)</td>
    </tr>
    <tr className='!bg-green-50'>
      <td className='p-3' rowSpan={4}><strong>Spoke Resource Group</strong></td>
      <td className='p-3'>Workspace</td>
      <td className='p-3 text-center'>✓</td>
    </tr>
    <tr className='!bg-green-50'>
      <td className='p-3'>Spoke VNET</td>
      <td className='p-3 text-center'>✓</td>
    </tr>
    <tr className='!bg-green-50'>
      <td className='p-3'>Back-end Private Endpoint</td>
      <td className='p-3 text-center'>✓</td>
    </tr>
    <tr className='!bg-green-50'>
      <td className='p-3'>UC Storage Account</td>
      <td className='p-3 text-center'>✓</td>
    </tr>
    <tr className='bg-gray-50'>
      <td className='p-3' rowSpan={3}><strong>Account Console</strong></td>
      <td className='p-3'>NCC (Network Connectivity Config)</td>
      <td className='p-3 text-center'>✗ (You provide)</td>
    </tr>
    <tr className='bg-gray-50'>
      <td className='p-3'>Network Policy</td>
      <td className='p-3 text-center'>✗ (You provide)</td>
    </tr>
    <tr className='bg-gray-50'>
      <td className='p-3'>Metastore</td>
      <td className='p-3 text-center'>✗ (You provide)</td>
    </tr>
  </tbody>
</table>
</div>

## Configuration
```hcl
create_hub = false
```

## Required Variables

<Admonition type="warning" title="Additional Requirements">

When `create_hub = false`, you must provide several additional variables from your existing hub infrastructure.

</Admonition>

```hcl
# Disable hub creation
create_hub = false

# Basic configuration
location        = "westus2"
subscription_id = "ffffffff-ffff-ffff-ffff-ffffffffffff"
resource_suffix = "spoke"

# REQUIRED: Existing metastore from your hub
databricks_metastore_id = "00000000-0000-0000-0000-000000000000"

# REQUIRED: Existing hub VNET details (for spoke network peering)
existing_hub_vnet = {
  route_table_id = "/subscriptions/.../providers/Microsoft.Network/routeTables/rt-hub"
  vnet_id        = "/subscriptions/.../providers/Microsoft.Network/virtualNetworks/vnet-hub"
}

# REQUIRED: Existing NCC and network policy
existing_ncc_id            = "your-ncc-id"
existing_network_policy_id = "your-network-policy-id"

# REQUIRED if cmk_enabled = true (default)
existing_cmk_ids = {
  key_vault_id            = "/subscriptions/.../providers/Microsoft.KeyVault/vaults/kv-hub"
  managed_disk_key_id     = "https://kv-hub.vault.azure.net/keys/cmk-disk/version"
  managed_services_key_id = "https://kv-hub.vault.azure.net/keys/cmk-services/version"
}

tags = {
  Owner = "user@example.com"
}
```

### Required Variable Summary
- `databricks_account_id`
- `location`
- `subscription_id`
- `resource_suffix`
- `databricks_metastore_id`
- `existing_ncc_id`
- `existing_network_policy_id`
- `existing_hub_vnet`
- `existing_cmk_ids` (if `cmk_enabled = true`)

## Template File
Use `template_byo_hub.example.tfvars` as the template for this type of deployment.

## Important Notes

<Admonition type="info" title="CMK Configuration">

If `cmk_enabled = true` (default), you must provide `existing_cmk_ids`. Alternatively, you can disable CMK:

```hcl
cmk_enabled = false
```

</Admonition>

<Admonition type="warning" title="SAT Not Available">

The Security Analysis Tool (SAT) can only be deployed when `create_hub = true`. If you need SAT with a BYO hub deployment, you must deploy it separately.

</Admonition>

## Validation Rules

When `create_hub = false`:
- Must provide `databricks_metastore_id`
- Must provide `existing_ncc_id`
- Must provide `existing_network_policy_id`
- Must provide `existing_hub_vnet`
- Must provide `existing_cmk_ids` if `cmk_enabled = true`
- Must NOT provide `existing_cmk_ids` if `cmk_enabled = false`

## Next Steps

1. Copy `template_byo_hub.example.tfvars` to `terraform.tfvars`
2. Fill in required variables from your existing hub infrastructure
3. Review [Configuration Reference](./configuration.mdx) for optional features
4. Follow [Getting Started](./gettingstarted.mdx) deployment steps
